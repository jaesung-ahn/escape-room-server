<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorator="~{layout/layout}">

<!--<th:block layout:fragment="css">-->
<!--</th:block>-->
<!--<th:block layout:fragment="script">-->
<!--</th:block>-->

<div id="content" layout:fragment="content">
    <!-- Breadcrumbs-->
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a th:href="@{/admin/main}">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">컨텐츠 추천 관리</li>
    </ol>

    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-table"></i>
            <span>컨텐츠 추천 관리</span>
        </div>
        <div class="card-body row">

            <div class="list_search_region">
                <p>

                </p>
            </div>

            <form id="recommendation-form" role="form" th:object="${recommendationForm}"
                  style="width:1000px">
                <div class="form-group">
                    <input  class="form-control" type="text"
                            hidden
                            th:field="*{id}">
                    <div class="table-responsive list-table-region">
                        <table class="table table-bordered table-hover table-striped" id="dataTable" width="100%" cellspacing="0">
                            <tbody id="table_rec_list">
                            <tr>
                                <td class="detail-left-td-info"> 카테고리 제목<span style="color:red">*</span> </td>
                                <td class="detail-content-td" colspan="3">
                                    <input class="form-control" type="text"
                                           placeholder=""
                                           th:field="*{categoryName}"
                                    >
                                </td>
                            </tr>

                            <tr>
                                <td class="detail-left-td-info"> 지역</td>
                                <td class="detail-content-td" colspan="3">
                                    <select th:field="*{cityCode}" class="form-select form-control" style=" width:160px;"
                                    >
                                        <option th:each="city : ${seoulCities}"
                                                th:value="${city.getCode()}"
                                                th:text="${city.getName()}">
                                        </option>
                                    </select>
                                </td>
                            </tr>

                            <tr>
                                <td class="detail-left-td-info"> 성별 </td>
                                <td class="detail-content-td" colspan="3">
                                    <select th:field="*{userGenderTypeCode}" class="form-select form-control" style=" width:160px;"
                                    >
                                        <option th:each="userGenderType : ${userGenderTypes}"
                                                th:value="${userGenderType.getCode()}"
                                                th:text="${userGenderType.getName()}">
                                        </option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td class="detail-left-td-info"> 연령대 </td>
                                <td class="detail-content-td" colspan="3">
                                    <select th:field="*{ageGroupInfoCode}" class="form-select form-control" style=" width:160px;"
                                    >
                                        <option th:each="ageGroupInfo : ${ageGroupInfos}"
                                                th:value="${ageGroupInfo.getCode()}"
                                                th:text="${ageGroupInfo.getName()}">
                                        </option>
                                    </select>
                                </td>
                            </tr>

                            <tr>
                                <td class="detail-left-td-info"> 놀거리</td>
                                <td class="detail-content-td" colspan="3">
                                    <div class="table-responsive list-table-region">
                                    <table id="content_table" class="table table-bordered " width="100%" cellspacing="0">
                                        <tbody id="table_content_list">
                                            <tr>
                                                <td class="detail-content-td"> no. </td>
                                                <td class="detail-content-td"> 놀거리명 </td>
                                                <td class="detail-content-td">
                                                    <div style='clear:both'>
                                                        <button type='button' class='btn btn-primary add-content-btn' style='float:left; margin-left:12px;'>
                                                            추가</button>

                                                    </div>
                                                </td>
                                            </tr>
                                            <tr th:each="contentForm : ${recommendationForm.contentForms}">
                                                <td class="detail-content-td content-id"
                                                    th:text="${contentForm.contentId}"> 1 </td>
                                                <td class="detail-content-td"
                                                    th:text="${contentForm.contentName}"> 방탈출A </td>
                                                <td class="detail-content-td">
                                                    <div style='clear:both'>
                                                        <button type='button' class='btn btn-primary add-content-btn' style='float:left; margin-left:12px;'>
                                                            추가</button>
                                                        <button type='button' class='btn btn-danger del-content-btn' style='float:left; margin-left:12px;' >
                                                            삭제</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    </div>
                                </td>
                            </tr>

                            <tr>
                                <td class="detail-left-td-info"> 작성일</td>
                                <td class="detail-content-td" colspan="3">
                                    <input  class="form-control" type="text"
                                            th:field="*{createdAt}"
                                            readonly
                                    >
                                </td>
                            </tr>


                            </tbody>
                        </table>
                    </div>

                </div>
                <div style="width: 100%; height:60px;clear:both; text-align:center;">
                    <button id="back-button" type="button" class="btn btn-secondary" >취소</button>
                    <button id="submit-button" type="button" class="btn btn-primary" style=" margin-left:12px;">저장</button>
                </div>
            </form>
        </div>

        <div class="card-footer small text-muted"></div>

        <!-- Element to pop up -->
        <div id="element_to_pop_up">
            <a class="b-close">닫기</a>
            <div>
                <table class="table table-bordered table-hover table-striped" width="100%" cellspacing="0">
                    <tbody id="table_popup_list">

                    <tr>
                        <td>no.</td>
                        <td>업체명</td>
                        <td>놀거리명</td>
                        <td></td>
                    </tr>
                    <tr th:each="content : ${contents}">
                        <td class="detail-content-td"
                            th:text="${content.id}"> 1 </td>
                        <td class="detail-content-td"
                            th:text="${content.companyName}"> 업체명 </td>
                        <td class="detail-content-td"
                            th:text="${content.name}"> 놀거리명 </td>
                        <td class="detail-content-td">
                            <div style='clear:both'>
                                <button type='button' class='btn btn-primary sel-content-btn' style='float:left; margin-left:12px;'
                                        th:attr="contentId=${content.id},contentName=${content.name}"
                                    >
                                    선택</button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="text/javascript">
    </script>

    <script type="text/javascript" th:src="@{/js/jquery.bpopup.min.js}"></script>

    <style>
    #element_to_pop_up {
        background-color:#fff;
        border-radius:5px;
        color:#000;
        display:none;
        padding:20px;
        min-width:400px;
        min-height: 180px;
    }
    .b-close{
        cursor:pointer;
        position:absolute;
        right:10px;
        top:5px;
    }
    </style>
    <script th:inline="javascript">
        var bPopupElement = $('#element_to_pop_up');
        // bPopup.close();
        let contentSet = new Set();

        // 보유한 놀거리 초기화
        var contentsList = [[${recommendationForm.contentForms}]];
        var id = [[${recommendationForm.id}]];

        if (contentsList != null && contentsList.length > 0) {
            $.each(contentsList, function(index, element) {
                console.log(element);
                contentSet.add(element['contentId']);
            });
        }

        console.log(contentSet);

        var show_popup_func = function(){
            bPopupElement.bPopup();
        };
        var del_content_func = function(){
            var _this = $(this);
            _this.parent().parent().parent().remove();

            var contentId = parseInt(_this.parent().parent().parent().children('.content-id').text());

            contentSet.delete(contentId);
        };

        $('.add-content-btn').click(show_popup_func);
        $('.del-content-btn').click(del_content_func);

        $('.sel-content-btn').click(function(){
            var contentId = parseInt($(this).attr('contentId'));
            var contentName = $(this).attr('contentName');
            console.log(contentId);
            console.log(contentName);

            console.log('contentSet:', contentSet);
            if (contentSet.has(contentId) == false) {
                bPopupElement.close();
                $('#table_content_list').append(
                    "<tr >                                                <td class='detail-content-td content-id'                                                    > "+contentId+" </td>                                                <td class='detail-content-td'                                                    > " + contentName+"</td>                                                <td class='detail-content-td'>                                                    <div style='clear:both'>                                                        <button type='button' class='btn btn-primary add-content-btn' style='float:left; margin-left:12px;'>                                                            추가</button>                                                        <button type='button' class='btn btn-danger del-content-btn' style='float:left; margin-left:12px;' >                                                            삭제</button>                                                    </div>                                                </td>                                            </tr>"
                );
                $('.add-content-btn').click(show_popup_func);
                $('.del-content-btn').click(del_content_func);
                contentSet.add(contentId);
            }
            else {
                alert('이미 보유한 놀거리 입니다.');
            }
        });

        $('#submit-button').click(function(){
            $.ajax({
                type: "POST",
                dataType: 'json',
                traditional : true,
                url: "/admin/recommendation/save",
                data: {
                    "id": id,
                    "recommendationForm": JSON.stringify($("#recommendation-form").serializeArray()),
                    "contentList": Array.from(contentSet)
                },
                success: function(response){

                    if(response.status == '0000'){
                        // console.log('success');
                        console.log(response);
                        alert('수정/등록 되었습니다.');

                        location.replace('/admin/recommendation/list');
                    }
                    else{
                        console.log('response:', response);
                        alert(response.message);
                    }
                },
                error: function(request, status, error){
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    alert("서버 통신 중 오류가 발생하였습니다.");
                },
            });
        });




    </script>
</div>

</html>