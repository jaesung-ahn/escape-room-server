# Wiiee 프로젝트 개선 작업 목록

> Phase별 상세 작업 및 체크리스트

**참조**: [종합 개선 계획](./종합%20개선%20계획.md) - 전략 및 개선 방향

---

## 우선순위별 작업 목록

### 즉시 (이번 주, Critical)

- [x] JWT Secret Key 환경변수화
- [x] RBAC 기본 구현 (Role enum, getAuthorities())
- [x] RecommendationService N+1 제거
- [x] ContentService 배치 이미지 로딩

### 1주차 (High Priority)

- [ ] GatheringService 분해 설계
- [x] RuntimeException → ApiException 계층화
- [x] 리소스 접근 권한 검증 강화
- [x] 필수 인덱스 생성 (6개)

### 2-3주차 (Medium Priority)

- [ ] GatheringService 분해 구현
- [ ] UserService 분해
- [ ] QueryDSL Fetch Join 추가
- [ ] Connection Pool 튜닝
- [ ] 보안 헤더 설정
- [ ] CORS 상세 설정

### 4-6주차 (Long-term)

- [ ] Redis 캐싱 구현
- [ ] Rate Limiting 구현
- [ ] CI/CD 파이프라인 구축
- [ ] Dockerfile 작성
- [ ] 단위 테스트 50개 작성
- [ ] 모니터링 대시보드 구축

---

## Phase 1: 긴급 보안 및 성능 (1-2주)

### 1.1 보안 Critical 체크리스트

**P0: JWT Secret Key 환경변수화**
- [x] `JwtTokenProvider.java:27` 하드코딩된 secret 제거
- [x] `application.yml`에 jwt.secret 설정 추가
- [x] `application-prod.yml` 환경변수 주입 설정
- [x] `.env` 파일 또는 환경변수 설정 문서화
- [x] 기존 토큰 무효화 및 재발급 로직 검토

**P0: RBAC 구현**
- [x] `User.java`에 Role 필드 추가 (UserRole enum)
- [x] UserRole enum 생성 (USER, ADMIN)
- [x] `SecurityUser.getAuthorities()` 구현
- [x] `SecurityConfig` @PreAuthorize 활성화
- [x] 주요 엔드포인트에 @PreAuthorize 적용 (2개)
  - [x] `/api/company` (POST) - ADMIN만
  - [x] `/api/content` (POST) - ADMIN만
  - [ ] `/api/review/approve` - ADMIN만 (API 없음)
  - [ ] 기타 관리자 전용 API

**P1: 리소스 접근 권한 검증**
- [x] `GatheringService.updateGathering()` 권한 검증 강화 (기존 완료)
- [x] `UserService.updateUser()` 권한 검증 추가
- [x] `UserService.updateUserSignupEtc()` 권한 검증 추가
- [x] `MemberService.updateMember()` 권한 검증 추가 (본인 또는 호스트)
- [x] 권한 검증 실패 시 403 Forbidden 응답

### 1.2 성능 Critical 체크리스트

**P0: N+1 쿼리 제거**

대상 1: RecommendationService
- [x] `RecommendationService.getRecommendations()` 분석
- [x] RecommendationRepository에 Fetch Join 쿼리 추가
- [x] 통합 테스트 작성 및 검증 완료

대상 2: ContentService
- [x] `ContentService.getContentSimpleModelsByContents()` 분석
- [x] 이미지 ID 목록 수집
- [x] `imageService.findByIdsIn()` 배치 조회 구현
- [x] Map으로 변환하여 O(1) 조회
- [x] 통합 테스트로 검증 완료

대상 3: GatheringService
- [x] `GatheringService.getWaitingMember()` 분석
- [x] 멤버 프로필 이미지 배치 로딩
- [x] 테스트: 쿼리 개수 확인 (6개 → 2-3개)

대상 4: CommentService
- [x] `CommentService` 대댓글 조회 분석
- [x] @Fetch(FetchMode.SUBSELECT) 또는 별도 쿼리
- [x] 배치 로딩 적용 (getComments, update)
- [x] 테스트: 쿼리 개수 확인 (50개 → 6개)

**성능 테스트**
- [ ] 개선 전 응답 시간 측정
- [ ] 개선 후 응답 시간 측정
- [ ] 쿼리 로그 비교 분석

---

## Phase 2: 아키텍처 리팩토링 (3-4주)

### 2.1 GatheringService 분해

**설계**
- [ ] 책임 분리 설계 (4개 서비스)
- [ ] 인터페이스 및 메서드 시그니처 정의
- [ ] 의존성 그래프 작성

**구현**
- [ ] GatheringMemberService 생성 (150줄)
  - [ ] addMember()
  - [ ] updateMember()
  - [ ] getMembers()
  - [ ] removeMember()
- [ ] GatheringRequestService 생성 (100줄)
  - [ ] createRequest()
  - [ ] approveRequest()
  - [ ] rejectRequest()
  - [ ] cancelRequest()
- [ ] GatheringNotificationService 생성 (100줄, 비동기)
  - [ ] notifyRequestCreated()
  - [ ] notifyRequestApproved()
  - [ ] notifyRequestRejected()
  - [ ] @Async 설정
- [ ] GatheringService 정리 (528줄 → 150줄)
  - [ ] 핵심 CRUD만 유지
  - [ ] 분리된 서비스 의존성 주입

**테스트**
- [ ] 기존 Acceptance 테스트 통과 확인
- [ ] 서비스별 단위 테스트 작성

### 2.2 UserService 분해

**설계**
- [ ] 책임 분리 설계 (3개 서비스)

**구현**
- [ ] AuthService 생성
  - [ ] signup()
  - [ ] login()
  - [ ] refresh()
- [ ] UserProfileService 생성
  - [ ] getProfile()
  - [ ] updateProfile()
  - [ ] uploadProfileImage()
- [ ] UserRecommendationFacadeService 생성
  - [ ] getRecommendations()
- [ ] UserService 정리 (226줄 → 100줄)

**테스트**
- [ ] 기존 Acceptance 테스트 통과 확인
- [ ] 서비스별 단위 테스트 작성

### 2.3 예외 처리 통일

**ApiException 계층 구조 생성**
- [x] `api/application/exception/ApiException.java` (기본 클래스)
- [x] `ResourceNotFoundException.java` (404)
- [x] `UnauthorizedException.java` (401)
- [x] `ForbiddenException.java` (403)
- [x] `BadRequestException.java` (400)
- [x] `ConflictException.java` (409)
- [x] `InternalServerException.java` (500)
- [x] `ApiExceptionHandler.java` 개선 (ResponseEntity 사용하여 동적 HTTP 상태 코드)

**RuntimeException 제거**
- [x] UserService: 7개 → ApiException (ConflictException, ResourceNotFoundException, ForbiddenException)
- [x] MemberService: 1개 → ConflictException
- [x] ReviewService: 2개 → ForbiddenException
- [x] ContentFavoriteService: 1개 → ConflictException
- [x] GatheringFavoriteService: 1개 → ConflictException

**에러 코드 중앙화**
- [x] UserErrorCode 생성 (이메일 중복, 차단, 휴면, 탈퇴)
- [x] ContentErrorCode 생성 (찜 중복)
- [x] ReviewErrorCode 생성 (수정/삭제 권한)
- [x] GatheringErrorCode 확장 (찜 중복, 멤버 등록 불가, 모집 완료/만료/마감 등 6개)
- [x] WbtiErrorCode 생성 (WBTI 없음)
- [x] GatheringCommentErrorCode (기존 유지)

**CustomException → ApiException 변환**
- [x] GatheringService: 18개 → ApiException (ForbiddenException, ConflictException, ResourceNotFoundException, BadRequestException)
- [x] CommentService: 1개 → ForbiddenException
- [x] GatheringManager: 1개 → BadRequestException
- [x] WbtiService: 1개 → ResourceNotFoundException

**StatusCode 클래스 제거**
- [x] StatusCode.java 삭제
- [x] ApiResponse.java (StatusCode.OK_CODE → HttpStatus.OK.value())
- [x] 모든 StatusCode 참조 제거 완료

**테스트**
- [x] MemberAcceptanceTest 수정 (409 상태 코드)
- [x] GatheringAcceptanceTest 수정 (403 상태 코드)
- [x] WbtiAcceptanceTest 수정 (404 상태 코드)
- [x] 전체 인수 테스트 통과 (81개)

### 2.4 DTO 변환 로직 통일

**방안 검토**
- [ ] 현재 ModelMapper 사용 현황 분석
- [ ] MapStruct 도입 검토 (성능, 유지보수성)
- [ ] 최종 방안 결정

**구현 (선택된 방안)**
- [ ] 68개 Model 클래스 변환 로직 통일
- [ ] 공통 매핑 설정
- [ ] 테스트 작성

---

## Phase 3: 성능 최적화 및 인프라 (4-6주)

### 3.1 데이터베이스 최적화

**인덱스 생성**
- [x] `users.email` 인덱스
- [x] `content(company_id, is_operated)` 복합 인덱스
- [x] `gathering(user_id, deleted)` 복합 인덱스
- [x] `review(content_id, is_approval)` 복합 인덱스
- [x] `comment(gathering_id, parent_id)` 복합 인덱스
- [x] `gathering_request(gathering_id, request_status)` 복합 인덱스

**QueryDSL 최적화**
- [ ] ContentCustomRepositoryImpl Fetch Join 추가
- [ ] GatheringCustomRepositoryImpl Fetch Join 추가
- [ ] count 쿼리 최적화

**Connection Pool 튜닝**
- [ ] `application-prod.yml` hikari 설정
  - [ ] maximum-pool-size: 20
  - [ ] minimum-idle: 5
  - [ ] idle-timeout: 300000
  - [ ] max-lifetime: 1200000
  - [ ] connection-timeout: 30000

### 3.2 캐싱 전략

**Redis 설정**
- [ ] Redis 의존성 추가 (spring-boot-starter-data-redis)
- [ ] `application.yml` Redis 설정
- [ ] RedisConfig 생성
- [ ] @EnableCaching 설정

**캐시 구현**
- [ ] WBTI 데이터 캐싱 (TTL: 1시간)
- [ ] 추천 데이터 캐싱 (TTL: 15분)
- [ ] 컨텐츠 목록 캐싱 (TTL: 5분)
- [ ] FAQ 캐싱 (TTL: 1일)

**캐시 무효화**
- [ ] 데이터 변경 시 캐시 무효화 로직
- [ ] @CacheEvict 적용

### 3.3 보안 강화

**보안 헤더**
- [ ] SecurityConfig 보안 헤더 설정
  - [ ] X-Frame-Options: SAMEORIGIN
  - [ ] X-XSS-Protection
  - [ ] Content-Security-Policy

**CORS 설정**
- [ ] CorsConfigurationSource Bean 생성
- [ ] allowedOrigins 환경변수화
- [ ] allowedMethods 명시
- [ ] maxAge 설정

**Rate Limiting**
- [ ] Resilience4j 의존성 추가
- [ ] RateLimiter 설정
- [ ] 주요 엔드포인트에 적용
  - [ ] /api/user/login
  - [ ] /api/user (회원가입)
  - [ ] /api/gathering (생성)

**로깅 보안**
- [ ] 토큰 로깅 마스킹
- [ ] 비밀번호 로깅 제거
- [ ] 민감 정보 필터링

---

## Phase 4: DevOps 및 품질 (6-8주)

### 4.1 CI/CD 파이프라인

**GitHub Actions 워크플로우**
- [ ] `.github/workflows/ci.yml` 생성
- [ ] test job 구성
  - [ ] JDK 17 설정
  - [ ] ./gradlew test 실행
  - [ ] JaCoCo 리포트 생성
- [ ] build job 구성
  - [ ] Docker 이미지 빌드
  - [ ] Docker Hub 푸시
- [ ] deploy job 구성 (선택)

**커버리지 리포트**
- [ ] Codecov 계정 설정
- [ ] codecov.yml 설정
- [ ] 커버리지 배지 README 추가

### 4.2 컨테이너화

**Dockerfile**
- [ ] `api/Dockerfile` 작성
- [ ] `admin/Dockerfile` 작성 (선택)
- [ ] `push/Dockerfile` 작성 (선택)
- [ ] .dockerignore 설정

**docker-compose.yml**
- [ ] api 서비스 설정
- [ ] postgres 서비스 설정
- [ ] redis 서비스 설정
- [ ] 볼륨 설정
- [ ] 네트워크 설정
- [ ] 환경변수 .env 파일 분리

**테스트**
- [ ] docker-compose up 로컬 테스트
- [ ] 각 서비스 정상 동작 확인

### 4.3 테스트 커버리지

**단위 테스트 작성**
- [ ] GatheringServiceTest (10개 테스트)
- [ ] UserServiceTest (8개 테스트)
- [ ] ContentServiceTest (8개 테스트)
- [ ] ReviewServiceTest (5개 테스트)
- [ ] CommentServiceTest (5개 테스트)
- [ ] 기타 서비스 테스트 (14개)

**JaCoCo 설정**
- [ ] `api/build.gradle` JaCoCo 플러그인 설정
- [ ] jacocoTestReport 태스크 설정
- [ ] jacocoTestCoverageVerification 태스크 설정
- [ ] 커버리지 목표: 70%

**통합 테스트 확대**
- [ ] 복잡한 비즈니스 로직 통합 테스트
- [ ] 트랜잭션 경계 테스트

### 4.4 모니터링 및 로깅

**Actuator + Prometheus**
- [ ] spring-boot-starter-actuator 의존성 추가
- [ ] micrometer-registry-prometheus 의존성 추가
- [ ] `application-prod.yml` actuator 설정
  - [ ] health, metrics, prometheus 엔드포인트 노출

**Grafana 대시보드**
- [ ] Prometheus 설치 및 설정
- [ ] Grafana 설치 및 설정
- [ ] Spring Boot 대시보드 임포트
- [ ] 커스텀 메트릭 추가

**구조화된 로깅**
- [ ] logback-spring.xml 설정
- [ ] Logstash Encoder 의존성 추가
- [ ] JSON 로그 포맷 설정
- [ ] 로그 레벨 환경별 설정

---

## 주요 수정 파일 목록

### Critical 수정 파일 (Phase 1)

```
api/
├── src/main/java/com/wiiee/server/api/
│   ├── infrastructure/jwt/
│   │   └── JwtTokenProvider.java (JWT Secret 환경변수화)
│   ├── application/security/
│   │   ├── SecurityConfig.java (RBAC, 보안 헤더)
│   │   └── SecurityUser.java (getAuthorities() 구현)
│   ├── domain/
│   │   ├── recommendation/
│   │   │   └── RecommendationService.java (N+1 제거)
│   │   ├── content/
│   │   │   └── ContentService.java (배치 로딩)
│   │   ├── gathering/
│   │   │   └── GatheringService.java (N+1 제거, 향후 분해)
│   │   └── user/
│   │       └── UserService.java (RuntimeException 제거)
│
├── src/main/resources/
│   ├── application.yml
│   ├── application-prod.yml (신규)
│   └── application-local.yml (수정)
│
common/
└── src/main/java/com/wiiee/server/common/domain/
    └── user/
        └── User.java (Role 필드 추가)
```

### 신규 생성 파일

```
.github/
└── workflows/
    └── ci.yml (신규)

api/
├── Dockerfile (신규)
└── src/main/java/com/wiiee/server/api/
    ├── domain/gathering/
    │   ├── GatheringMemberService.java (신규)
    │   ├── GatheringRequestService.java (신규)
    │   └── GatheringNotificationService.java (신규)
    ├── domain/user/
    │   ├── AuthService.java (신규)
    │   ├── UserProfileService.java (신규)
    │   └── UserRecommendationFacadeService.java (신규)
    ├── application/exception/
    │   ├── ApiException.java (완료)
    │   ├── ResourceNotFoundException.java (완료)
    │   ├── UnauthorizedException.java (완료)
    │   ├── ForbiddenException.java (완료)
    │   ├── BadRequestException.java (완료)
    │   ├── ConflictException.java (완료)
    │   └── InternalServerException.java (완료)
    └── domain/code/
        ├── UserErrorCode.java (완료)
        ├── ContentErrorCode.java (완료)
        └── ReviewErrorCode.java (완료)

docker-compose.yml (신규)
.dockerignore (신규)
.env.example (신규)
```

---

## 6개월 스프린트 계획

### Sprint 1-2 (1개월): 보안 & 성능 기반

**Sprint 1 (2주)**
- Developer A: JWT Secret 환경변수화, User Role 추가, SecurityUser 구현
- Developer B: RecommendationService N+1 제거, ContentService 배치 로딩, 인덱스 3개 생성
- Developer C: Docker 개발 환경 구성, application-prod.yml 분리
- Developer D: 보안 개선 테스트, 성능 측정 기준선

**Sprint 2 (2주)**
- Developer A: RBAC @PreAuthorize 적용, SecurityConfig 보안 헤더, CORS 설정
- Developer B: GatheringService N+1 제거, CommentService N+1 제거, 인덱스 3개 생성, Connection Pool 튜닝
- Developer C: GitHub Actions CI 구축, Dockerfile 작성, docker-compose.yml
- Developer D: N+1 제거 전후 성능 테스트, API 응답 시간 측정

**1개월 마일스톤**:
- 보안 Critical 이슈 해결 (JWT, RBAC)
- 주요 N+1 쿼리 제거 (4개 서비스)
- 기본 CI/CD 구축

### Sprint 3-4 (2개월차): 아키텍처 리팩토링

**Sprint 3 (2주)**
- Developer A: ApiException 계층 구조, GatheringService 분해 설계, GatheringMemberService 구현
- Developer B: ContentCustomRepositoryImpl Fetch Join, GatheringCustomRepositoryImpl Fetch Join
- Developer C: Redis 로컬 환경 구성, @EnableCaching 설정, WBTI 캐싱
- Developer D & E: UserService RuntimeException → ApiException, ReviewService 예외 처리

**Sprint 4 (2주)**
- Developer A: GatheringRequestService 구현, GatheringNotificationService 구현, UserService 분해 설계
- Developer B: 추천 데이터 캐싱, 컨텐츠 목록 캐싱, 캐시 TTL 설정
- Developer C: GitHub Actions CD 구축, Docker Registry 설정, Staging 환경
- Developer D & E: GatheringService 분해 테스트, 리팩토링 회귀 테스트

**2개월 마일스톤**:
- God Service 분해 완료 (Gathering 4개, User 3개)
- 예외 처리 통일 (RuntimeException 0개)
- Redis 캐싱 적용 (주요 API 3개+)

### Sprint 5-6 (3개월차): 품질 & DevOps 고도화

**Sprint 5 (2주)**
- Developer A: AuthService, UserProfileService 분리, UserRecommendationFacadeService 구현
- Developer B: DTO 프로젝션 활용, 쿼리 성능 프로파일링
- Developer C: Prometheus + Grafana 구성, Spring Actuator 설정, 대시보드 구축
- Developer D & E: 단위 테스트 20개 작성, JaCoCo 설정, 커버리지 50%

**Sprint 6 (2주)**
- Developer A & B: ModelMapper 또는 MapStruct 도입, 68개 Model 변환 로직 통일
- Developer C: Rate Limiting 구현, Logback JSON 설정, 알림 시스템
- Developer D & E: 단위 테스트 30개 추가, 통합 테스트 10개, 커버리지 70%

**3개월 마일스톤**:
- 아키텍처 리팩토링 완료 (서비스 분해, DTO 통일)
- 모니터링 대시보드 운영
- 테스트 커버리지 70%

### Sprint 7-12 (4-6개월차): 안정화 & 고도화

**Sprint 7-8 (4개월차)**
- Production 배포 준비 (환경변수, Secret 관리)
- 보안 감사
- 부하 테스트
- 배포 가이드 문서

**Sprint 9-10 (5개월차)**
- 비동기 작업 큐 도입 검토
- 이벤트 기반 아키텍처 적용
- 읽기 복제본 분리 검토
- 성능 최종 점검

**Sprint 11-12 (6개월차)**
- 기술 부채 정리
- 코드 리뷰 프로세스 정착
- 운영 매뉴얼 작성
- 팀 교육 및 지식 공유

**6개월 마일스톤**:
- Production 배포 준비 완료
- 전체 지표 목표 달성 (성능, 보안, 품질)
- 운영 체계 확립

---

## 팀 역할 분담 제안

**Developer A (시니어)**: 아키텍처 리팩토링, 보안 (RBAC)
**Developer B (시니어/미들)**: 성능 최적화 (N+1 제거, 인덱스)
**Developer C (미들)**: DevOps (CI/CD, Docker, 모니터링)
**Developer D (주니어)**: 테스트 작성, 문서화
**Developer E (선택)**: 예외 처리 통일, 코드 정리

---

## 주간 체크포인트

**매주 금요일 3시 (1시간)**

1. 완료 항목 리뷰 (각 15분)
   - 이번 주 완료 작업 데모
   - 코드 리뷰 및 피드백

2. 블로커 공유 (15분)
   - 진행 중 어려움
   - 도움 필요 사항

3. 다음 주 계획 (15분)
   - 우선순위 작업 확인
   - 작업 분배 조정

---

## 위험 관리

**잠재적 리스크**:
1. 리팩토링 중 버그 발생 → 회귀 테스트 강화
2. 팀원 역량 차이 → 페어 프로그래밍, 코드 리뷰
3. 일정 지연 → 2주마다 우선순위 재조정
4. 예산 초과 → 오픈소스 도구 우선 활용

**대응 전략**:
- 매 스프린트 마지막 날은 버퍼 (예상 밖 작업)
- Critical 이슈 발생 시 전체 팀 모여서 해결
- 기술 부채 20% 시간 확보

---

## 도구 및 인프라 예산

| 항목 | 비용 (월) | 필수 여부 |
|-----|----------|---------|
| AWS/GCP 개발 환경 | $100-200 | 필수 |
| Redis Cloud (캐시) | $0 (Free tier) | 필수 |
| GitHub Actions (CI/CD) | $0 (Free) | 필수 |
| Docker Hub | $0 (Free) | 필수 |
| Grafana Cloud | $0 (Free tier) | 권장 |
| Sentry (에러 모니터링) | $0 (Free tier) | 권장 |
| Slack | $0 (Free) | 필수 |

**총 예산**: 월 $100-200 (필수 항목만)

---

## 관련 문서

- [종합 개선 계획](./종합%20개선%20계획.md) - 전략 및 개선 방향
- [엔티티 의존 관계](./ENTITY_DEPENDENCIES.md) - 엔티티 구조

---

**작성일**: 2025-12-29
**최종 업데이트**: 2026-01-23 (리소스 접근 권한 검증 강화 완료)
